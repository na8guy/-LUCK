<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyU Wallet Verification</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline' 'unsafe-eval'; connect-src *;">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #status, #account, #signature {
            margin: 10px 0;
            word-wrap: break-word;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    
    <h1>LuckyU Wallet Verification</h1>
    <p id="message"></p>
    <p id="account">Account: Not connected</p>
    <p id="status">Status: Waiting for connection...</p>
    <button id="connectButton" onclick="connectWallet()">Connect Wallet</button>
    <button id="signButton" onclick="signMessage()" disabled>Sign Message</button>
    <p id="signature"></p>

    <!-- Load ethers.js from cdnjs with the correct integrity hash -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.8.0/ethers.umd.min.js" 
            integrity="sha512-C21HmUqeSZiTL3f66wq2C9hf846MbuGlR/QteoGqAMT1wnvGAq6J/tqq7LwQZ+NWDeBMH0lC5MTOfVMeaGvclA==" 
            crossorigin="anonymous" referrerpolicy="no-referrer" onload="onEthersLoaded()"></script>
    <script>
        function onEthersLoaded() {
            console.log("ethers loaded:", typeof ethers);
            document.getElementById('status').innerText = 'Status: ethers.js loaded. Please connect your wallet.';
        }

        let provider;
        let signer;
        let account;

        // Get the message from the URL query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const message = urlParams.get('message');
        document.getElementById('message').innerText = `Message to sign: ${message || 'No message provided'}`;

        async function connectWallet() {
            if (typeof ethers === 'undefined') {
                document.getElementById('status').innerText = 'Status: ethers.js failed to load. Please refresh the page or check your network.';
                return;
            }
            try {
                if (!window.ethereum) {
                    document.getElementById('status').innerText = 'Status: Please install MetaMask!';
                    return;
                }

                // Check if MetaMask is locked or unavailable
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (!accounts || accounts.length === 0) {
                    document.getElementById('status').innerText = 'Status: MetaMask is locked. Please unlock it and try again.';
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                console.log("Connected network:", network);

                // Switch to BNB Chain Testnet (chainId 97)
                if (network.chainId !== 97) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x61' }],
                        });
                        document.getElementById('status').innerText = 'Status: Switched to BNB Chain Testnet.';
                    } catch (switchError) {
                        console.error("Error switching network:", switchError);
                        if (switchError.code === 4902) {
                            // Chain not added, add it
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x61',
                                    chainName: 'BNB Chain Testnet',
                                    rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545'],
                                    nativeCurrency: {
                                        name: 'BNB',
                                        symbol: 'BNB',
                                        decimals: 18
                                    },
                                    blockExplorerUrls: ['https://testnet.bscscan.com']
                                }],
                            });
                            document.getElementById('status').innerText = 'Status: Added and switched to BNB Chain Testnet.';
                        } else {
                            throw switchError;
                        }
                    }
                }

                // Request accounts again after network switch
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();

                document.getElementById('account').innerText = `Account: ${account}`;
                document.getElementById('status').innerText = 'Status: Connected!';
                document.getElementById('signButton').disabled = false;
            } catch (error) {
                console.error("Error connecting to wallet:", error);
                document.getElementById('status').innerText = `Status: Error - ${error.message || 'Failed to connect to MetaMask'}`;
            }
        }

        async function signMessage() {
            if (typeof ethers === 'undefined') {
                document.getElementById('status').innerText = 'Status: ethers.js failed to load. Please refresh the page or check your network.';
                return;
            }
            if (!message) {
                document.getElementById('status').innerText = 'Status: No message to sign!';
                return;
            }

            try {
                const domain = {
                    name: 'LuckyU',
                    version: '1',
                    chainId: 97,
                    verifyingContract: '0x36a5699fe5d5a4ded79f041b444cfacdabf4e609'
                };
                const types = {
                    WalletVerification: [
                        { name: 'message', type: 'string' },
                        { name: 'userAddress', type: 'address' }
                    ]
                };
                const value = {
                    message: message,
                    userAddress: account
                };

                const signature = await signer._signTypedData(domain, types, value);
                document.getElementById('signature').innerText = `Signature: ${signature}`;
                document.getElementById('status').innerText = 'Status: Message signed! Copy the signature above and paste it in Telegram.';
            } catch (error) {
                console.error("Error signing message:", error);
                document.getElementById('status').innerText = `Status: Error - ${error.message}`;
            }
        }
    </script>
  
</body>
</html>