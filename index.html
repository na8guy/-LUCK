<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIP-712 Signing with MetaMask</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
            color: green;
        }
        #error {
            margin-top: 20px;
            color: red;
        }
    </style>
</head>
<body>
    <h2>EIP-712 Signing with MetaMask</h2>
    <button id="connectButton">Connect to MetaMask</button>
    <button id="signTypedDataV4Button" disabled>Sign Typed Data (v4)</button>
    <p id="account">Account: Not connected</p>
    <p id="status"></p>
    <p id="error"></p>

    <script>
        const connectButton = document.getElementById('connectButton');
        const signTypedDataV4Button = document.getElementById('signTypedDataV4Button');
        const accountDisplay = document.getElementById('account');
        const statusDisplay = document.getElementById('status');
        const errorDisplay = document.getElementById('error');

        let provider;
        let signer;
        let userAddress;

        // Connect to MetaMask
        connectButton.addEventListener('click', async () => {
            try {
                // Check if MetaMask is installed
                if (!window.ethereum) {
                    throw new Error('MetaMask is not installed. Please install it to proceed.');
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                accountDisplay.textContent = `Account: ${userAddress}`;
                signTypedDataV4Button.disabled = false;
                connectButton.disabled = true;
                statusDisplay.textContent = 'Connected to MetaMask!';
                errorDisplay.textContent = '';
            } catch (error) {
                errorDisplay.textContent = `Error: ${error.message}`;
                statusDisplay.textContent = '';
            }
        });

        // Sign Typed Data with EIP-712 (eth_signTypedData_v4)
        signTypedDataV4Button.addEventListener('click', async () => {
            try {
                // Clear previous messages
                statusDisplay.textContent = '';
                errorDisplay.textContent = '';

                // Define the EIP-712 domain separator
                const domain = {
                    name: 'Ether Mail',
                    version: '1',
                    chainId: await provider.getNetwork().then(net => net.chainId),
                    verifyingContract: '0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC'
                };

                // Define the types for the structured data
                const types = {
                    Person: [
                        { name: 'name', type: 'string' },
                        { name: 'wallets', type: 'address[]' }
                    ],
                    Mail: [
                        { name: 'from', type: 'Person' },
                        { name: 'to', type: 'Person[]' },
                        { name: 'contents', type: 'string' }
                    ]
                };

                // Define the message to sign
                const message = {
                    from: {
                        name: 'Cow',
                        wallets: [
                            '0xCD2a3d9F938E13CD947Ec05AbC7FE734Df8DD826',
                            '0xDeaDbeefdEAdbeefdEadbEEFdeadbeEFdEaDbeeF'
                        ]
                    },
                    to: [{
                        name: 'Bob',
                        wallets: [
                            '0xbBbBBBBbbBBBbbbBbbBbbbbBBbBbbbbBbBbbBBbB',
                            '0xB0BdaBea57B0BDABeA57b0bdABEA57b0BDabEa57'
                        ]
                    }],
                    contents: 'Hello, Bob!'
                };

                // Sign the typed data
                const signature = await provider.send('eth_signTypedData_v4', [
                    userAddress,
                    JSON.stringify({
                        domain,
                        types,
                        primaryType: 'Mail',
                        message
                    })
                ]);

                // Verify the signature
                const recoveredAddress = ethers.utils.verifyTypedData(
                    domain,
                    { Mail: types.Mail, Person: types.Person },
                    message,
                    signature
                );

                if (recoveredAddress.toLowerCase() === userAddress.toLowerCase()) {
                    statusDisplay.textContent = `Signature verified! Signed by: ${recoveredAddress}\nSignature: ${signature}`;
                } else {
                    errorDisplay.textContent = `Signature verification failed! Recovered: ${recoveredAddress}, Expected: ${userAddress}`;
                }
            } catch (error) {
                errorDisplay.textContent = `Error: ${error.message}`;
                statusDisplay.textContent = '';
            }
        });

        // Handle chain changes
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    accountDisplay.textContent = 'Account: Not connected';
                    signTypedDataV4Button.disabled = true;
                    connectButton.disabled = false;
                    statusDisplay.textContent = '';
                    errorDisplay.textContent = 'Please connect to MetaMask.';
                }
            });
        }
    </script>
</body>
</html>