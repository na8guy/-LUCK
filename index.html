<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luckie Lottery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.3.0/web3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #status, #error { margin: 10px 0; }
        #actionForm { margin-top: 20px; }
        button { padding: 10px; margin: 5px; }
        input { padding: 8px; margin: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Luckie Lottery</h1>
    <div id="walletStatus">Wallet: Not connected</div>
    <button id="setWalletButton" onclick="setWallet()">Connect Wallet</button>
    <button id="delinkWalletButton" onclick="delinkWallet()" class="hidden">Delink Wallet</button>
    <div id="lotteryStatus">Loading lottery status...</div>
    <div id="userInfo"></div>
    <div id="actionForm" class="hidden">
        <h3 id="actionTitle"></h3>
        <div id="actionDetails"></div>
        <input id="ticketCount" type="number" placeholder="Number of Tickets" min="1" class="hidden">
        <button id="actionButton" class="hidden">Execute Action</button>
    </div>
    <div id="error"></div>

    <script>
        let web3, lotteryContract, tokenContract, userAccount;
        const contractAddress = "0x68cd3f484B9b75d6336B942B3FEa11FBDBDfc359";
        // Replace with actual $LUCK token contract address
        const tokenContractAddress = "0xYOUR_TOKEN_CONTRACT_ADDRESS"; // Update from CASHBACK_CONTRACT_ADDRESS or TOKEN_DISTRIBUTION_CONTRACT_ADDRESS
        // ABI from LotteryContract.json (simplified)
        const lotteryABI = [
            {"constant":true,"inputs":[{"name":"lotteryId","type":"uint256"}],"name":"getLotteryInfo","outputs":[{"name":"startTime","type":"uint256"},{"name":"endTime","type":"uint256"},{"name":"resultTime","type":"uint256"},{"name":"ended","type":"bool"},{"name":"participants","type":"uint256"},{"name":"prizePool","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":true,"inputs":[],"name":"currentLotteryId","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"name":"lotteryId","type":"uint256"},{"name":"numberOfTickets","type":"uint256"}],"name":"buyTickets","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":true,"inputs":[],"name":"ticketPrice","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":true,"inputs":[],"name":"paused","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":true,"inputs":[{"name":"lotteryId","type":"uint256"},{"name":"user","type":"address"}],"name":"getUserTickets","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}
        ];
        // ERC20 ABI for $LUCK token
        const tokenABI = [
            {"constant":true,"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"}
        ];

        async function initWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                lotteryContract = new web3.eth.Contract(lotteryABI, contractAddress);
                tokenContract = new web3.eth.Contract(tokenABI, tokenContractAddress);
                // Check if wallet is already connected
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    updateWalletStatus();
                }
                checkLotteryStatus();
                handleBotAction();
            } else {
                document.getElementById('error').innerText = "Please install MetaMask!";
            }
        }

        async function setWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                localStorage.setItem('walletAddress', userAccount);
                updateWalletStatus();
                checkLotteryStatus();
            } catch (error) {
                document.getElementById('error').innerText = `Error connecting wallet: ${error.message}`;
            }
        }

        async function delinkWallet() {
            try {
                userAccount = null;
                localStorage.removeItem('walletAddress');
                updateWalletStatus();
                document.getElementById('actionForm').classList.add('hidden');
                document.getElementById('lotteryStatus').innerText = "Please connect a wallet to view lottery details.";
            } catch (error) {
                document.getElementById('error').innerText = `Error delinking wallet: ${error.message}`;
            }
        }

        function updateWalletStatus() {
            if (userAccount) {
                document.getElementById('walletStatus').innerText = `Wallet: ${userAccount}`;
                document.getElementById('setWalletButton').classList.add('hidden');
                document.getElementById('delinkWalletButton').classList.remove('hidden');
            } else {
                document.getElementById('walletStatus').innerText = "Wallet: Not connected";
                document.getElementById('setWalletButton').classList.remove('hidden');
                document.getElementById('delinkWalletButton').classList.add('hidden');
            }
        }

        async function checkLotteryStatus() {
            if (!userAccount) {
                document.getElementById('lotteryStatus').innerText = "Please connect a wallet to view lottery details.";
                return;
            }
            try {
                const currentId = await lotteryContract.methods.currentLotteryId().call();
                let lotteryId = currentId;
                let lotteryInfo = await lotteryContract.methods.getLotteryInfo(currentId).call();
                const currentTime = Math.floor(Date.now() / 1000);

                const paused = await lotteryContract.methods.paused().call();
                if (paused) {
                    document.getElementById('lotteryStatus').innerText = `Lottery is paused. Ticket purchases are disabled.`;
                    document.getElementById('actionForm').classList.add('hidden');
                    return;
                }

                // Check if in 1-hour break
                if (lotteryInfo.endTime <= currentTime && currentTime < lotteryInfo.resultTime) {
                    document.getElementById('lotteryStatus').innerText = `Lottery #${currentId} is in result preparation. Ticket purchases paused until ${new Date(lotteryInfo.resultTime * 1000).toUTCString()}.`;
                    document.getElementById('actionForm').classList.add('hidden');
                    return;
                }

                // If current lottery is ended, try next lottery
                if (lotteryInfo.ended) {
                    lotteryId = parseInt(currentId) + 1;
                    try {
                        lotteryInfo = await lotteryContract.methods.getLotteryInfo(lotteryId).call();
                        if (lotteryInfo.ended) {
                            document.getElementById('lotteryStatus').innerText = `No active or upcoming lottery available.`;
                            document.getElementById('actionForm').classList.add('hidden');
                            return;
                        }
                    } catch (error) {
                        document.getElementById('lotteryStatus').innerText = `No upcoming lottery available.`;
                        document.getElementById('actionForm').classList.add('hidden');
                        return;
                    }
                }

                const ticketPrice = await lotteryContract.methods.ticketPrice().call();
                const userTickets = await lotteryContract.methods.getUserTickets(lotteryId, userAccount).call();
                const tokenDecimals = await tokenContract.methods.decimals().call();
                const userBalance = await tokenContract.methods.balanceOf(userAccount).call();
                document.getElementById('lotteryStatus').innerText = `Lottery #${lotteryId} is active! Ticket Price: ${web3.utils.fromWei(ticketPrice, 'ether')} $LUCK`;
                document.getElementById('userInfo').innerText = `Your Balance: ${web3.utils.fromWei(userBalance, 'ether')} $LUCK\nYour Tickets: ${userTickets} for Lottery #${lotteryId}`;
            } catch (error) {
                document.getElementById('error').innerText = `Error checking lottery status: ${error.message}`;
            }
        }

        async function handleBotAction() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            if (!action) return;

            document.getElementById('actionForm').classList.remove('hidden');
            document.getElementById('actionButton').classList.remove('hidden');

            if (action === 'buy_tickets') {
                const lotteryId = urlParams.get('lotteryId') || await lotteryContract.methods.currentLotteryId().call();
                const ticketCount = urlParams.get('tickets') || 1;
                const ticketPrice = await lotteryContract.methods.ticketPrice().call();
                const tokenDecimals = await tokenContract.methods.decimals().call();
                const userBalance = userAccount ? await tokenContract.methods.balanceOf(userAccount).call() : '0';
                const totalCost = web3.utils.toBN(ticketPrice).mul(web3.utils.toBN(ticketCount));

                document.getElementById('actionTitle').innerText = `Buy Tickets for Lottery #${lotteryId}`;
                document.getElementById('actionDetails').innerText = `Ticket Price: ${web3.utils.fromWei(ticketPrice, 'ether')} $LUCK\nNumber of Tickets: ${ticketCount}\nTotal Cost: ${web3.utils.fromWei(totalCost, 'ether')} $LUCK\nYour Balance: ${web3.utils.fromWei(userBalance, 'ether')} $LUCK`;
                document.getElementById('ticketCount').value = ticketCount;
                document.getElementById('ticketCount').classList.remove('hidden');
                document.getElementById('actionButton').innerText = "Buy Tickets";
                document.getElementById('actionButton').onclick = () => buyTickets(lotteryId);
            } else if (action === 'delink_wallet') {
                document.getElementById('actionTitle').innerText = "Delink Wallet";
                document.getElementById('actionDetails').innerText = `Wallet: ${userAccount || 'Not connected'}\nClick below to delink your wallet.`;
                document.getElementById('actionButton').innerText = "Delink Wallet";
                document.getElementById('actionButton').onclick = delinkWallet;
            } else {
                document.getElementById('actionForm').classList.add('hidden');
                document.getElementById('error').innerText = `Unsupported action: ${action}`;
            }
        }

        async function buyTickets(lotteryId) {
            try {
                if (!userAccount) throw new Error("Please connect a wallet.");
                const ticketCount = document.getElementById('ticketCount').value;
                if (!ticketCount || ticketCount < 1) throw new Error("Please enter a valid number of tickets.");
                
                const ticketPrice = await lotteryContract.methods.ticketPrice().call();
                const totalCost = web3.utils.toBN(ticketPrice).mul(web3.utils.toBN(ticketCount));
                const userBalance = await tokenContract.methods.balanceOf(userAccount).call();
                if (web3.utils.toBN(userBalance).lt(totalCost)) {
                    throw new Error("Insufficient $LUCK balance for purchase.");
                }

                await lotteryContract.methods.buyTickets(lotteryId, ticketCount).send({ from: userAccount });
                document.getElementById('lotteryStatus').innerText = `Successfully bought ${ticketCount} ticket(s) for Lottery #${lotteryId}!`;
                checkLotteryStatus();
                document.getElementById('actionForm').classList.add('hidden');
            } catch (error) {
                document.getElementById('error').innerText = `Error buying tickets: ${error.message}`;
            }
        }

        window.onload = initWeb3;
    </script>
</body>
</html>