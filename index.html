<!DOCTYPE html>
<html>
<head>
    <!-- ... keep existing head content ... -->
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ðŸ¦™ Connect Your Wallet</h1>
            <div id="status">Initializing...</div>
            <div id="metaMaskSection" style="display: none;">
                <button onclick="connectWallet()" id="connectButton">Connect MetaMask</button>
            </div>
            <div id="mobileHelp" style="display: none; margin-top: 15px;">
                <p>ðŸ“± Mobile Tips:</p>
                <ol>
                    <li>Open in MetaMask browser</li>
                    <li>Enable "Web3 Provider" in settings</li>
                    <li>Refresh the page</li>
                </ol>
            </div>
            <div id="error" class="error"></div>
        </div>
    </div>

    <script>
        // Improved MetaMask detection logic
        async function checkMetaMask() {
            // Check multiple ways MetaMask might be injected
            const provider = window.ethereum || window.web3?.currentProvider;
            
            if (provider && provider.isMetaMask) {
                return true;
            }
            
            // Check if recently installed and needs page reload
            if (window.ethereum) {
                window.location.reload();
                return true;
            }
            
            return false;
        }

        async function init() {
            const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
            const hasMetaMask = await checkMetaMask();

            if (!hasMetaMask) {
                document.getElementById('status').textContent = 'MetaMask Not Found';
                document.getElementById('error').textContent = isMobile ?
                    'Try opening in MetaMask browser (click â‹¯ > Open in MetaMask)' :
                    'Install MetaMask or check browser extensions';
                
                if (isMobile) {
                    document.getElementById('mobileHelp').style.display = 'block';
                    // Improved mobile deep link
                    window.location.href = `https://metamask.app.link/dapp/${encodeURIComponent(window.location.href)}`;
                }
                return;
            }

            // Show connection UI if MetaMask found
            document.getElementById('status').textContent = 'MetaMask Detected!';
            document.getElementById('metaMaskSection').style.display = 'block';
            
            // Additional check for multiple wallets
            if (window.ethereum.providers?.length > 1) {
                document.getElementById('error').textContent = 
                    'Multiple wallets detected - please select MetaMask';
            }
        }

        async function connectWallet() {
            try {
                // Explicitly request MetaMask even with multiple providers
                const provider = window.ethereum.providers?.find(p => p.isMetaMask) || window.ethereum;
                
                // Force MetaMask to connect
                await provider.request({ method: 'eth_requestAccounts' });
                
                // Rest of connection logic...
                
            } catch (error) {
                showError(`Connection failed: ${error.message}`);
            }
        }

        // Enhanced mobile handling
        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
            // Add delay for mobile deep links
            setTimeout(() => {
                if (!window.ethereum) {
                    window.location.href = `https://metamask.app.link/dapp/${encodeURIComponent(window.location.href)}`;
                }
            }, 1500);
        }

        // Start initialization
        init();

        // Listen for provider changes
        window.addEventListener('ethereum#initialized', handleMetaMask, {
            once: true,
            passive: true
        });

        // Polling fallback
        let checkCount = 0;
        const interval = setInterval(() => {
            if (checkMetaMask() || checkCount++ > 10) {
                clearInterval(interval);
            }
        }, 100);
    </script>
</body>
</html>