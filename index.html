<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyU Wallet Connect</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { background: #5865F2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .error { color: #ff4444; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ðŸ¦™ Connect Your Wallet</h1>
            <div id="status">Initializing...</div>
            <button onclick="connectWallet()" id="connectButton">Connect MetaMask</button>
            <div id="error" class="error"></div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        let telegramId = params.get('telegramId');
        let nonce = params.get('nonce');
        let action = params.get('action');
        let message = params.get('message');

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showError('MetaMask not detected!');
                    return;
                }

                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const address = await signer.getAddress();

                // Verify network
                const network = await provider.getNetwork();
                if (network.chainId !== 97n) { // BSC Testnet
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x61' }] 
                    });
                }

                // Sign verification message
                const verificationMessage = decodeURIComponent(message) || 
                    `LuckyU Verification - Telegram ID: ${telegramId} - Nonce: ${nonce}`;
                
                const signature = await signer.signMessage(verificationMessage);

                // Send data back to Telegram bot
                const verificationData = {
                    type: "verification",
                    address: address,
                    signature: signature,
                    message: verificationMessage
                };

                if (window.Telegram.WebApp) {
                    window.Telegram.WebApp.sendData(JSON.stringify(verificationData));
                    window.Telegram.WebApp.close();
                } else {
                    showError('Telegram context missing - please return to Telegram');
                }
            } catch (error) {
                showError(`Connection failed: ${error.message}`);
            }
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
        }

        // Initialize based on URL parameters
        function init() {
            if (action === 'verify' && telegramId && nonce) {
                document.getElementById('status').textContent = 'Ready to verify wallet...';
            } else {
                showError('Invalid verification parameters');
                document.getElementById('connectButton').disabled = true;
            }
        }

        // Handle mobile MetaMask launch
        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
            window.location.href = `https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}?${window.location.search}`;
        } else {
            init();
        }
    </script>
</body>
</html>