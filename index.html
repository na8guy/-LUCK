<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyU Wallet Verification</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://cdn.ethers.io 'unsafe-inline' 'unsafe-eval'; connect-src *;">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #status, #account, #signature {
            margin: 10px 0;
            word-wrap: break-word;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>LuckyU Wallet Verification</h1>
    <p id="message"></p>
    <p id="account">Account: Not connected</p>
    <p id="status">Status: Waiting for connection...</p>
    <button id="connectButton" onclick="connectWallet()">Connect Wallet</button>
    <button id="signButton" onclick="signMessage()" disabled>Sign Message</button>
    <p id="signature"></p>

    <!-- Load ethers.js from a CDN -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" onload="onEthersLoaded()"></script>
    <script>
        function onEthersLoaded() {
            console.log("ethers loaded:", typeof ethers);
            document.getElementById('status').innerText = 'Status: ethers.js loaded. Please connect your wallet.';
        }

        let provider;
        let signer;
        let account;

        // Get the message from the URL query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const message = urlParams.get('message');
        document.getElementById('message').innerText = `Message to sign: ${message || 'No message provided'}`;

        async function connectWallet() {
            if (typeof ethers === 'undefined') {
                document.getElementById('status').innerText = 'Status: ethers.js failed to load. Please refresh the page or check your network.';
                return;
            }
            try {
                if (!window.ethereum) {
                    document.getElementById('status').innerText = 'Status: Please install MetaMask!';
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                if (network.chainId !== 97) {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x61' }],
                    });
                }

                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();

                document.getElementById('account').innerText = `Account: ${account}`;
                document.getElementById('status').innerText = 'Status: Connected!';
                document.getElementById('signButton').disabled = false;
            } catch (error) {
                console.error("Error connecting to wallet:", error);
                document.getElementById('status').innerText = `Status: Error - ${error.message}`;
            }
        }

        async function signMessage() {
            if (typeof ethers === 'undefined') {
                document.getElementById('status').innerText = 'Status: ethers.js failed to load. Please refresh the page or check your network.';
                return;
            }
            if (!message) {
                document.getElementById('status').innerText = 'Status: No message to sign!';
                return;
            }

            try {
                const domain = {
                    name: 'LuckyU',
                    version: '1',
                    chainId: 97,
                    verifyingContract: '0x36a5699fe5d5a4ded79f041b444cfacdabf4e609' // Replace with actual address
                };
                const types = {
                    WalletVerification: [
                        { name: 'message', type: 'string' },
                        { name: 'userAddress', type: 'address' }
                    ]
                };
                const value = {
                    message: message,
                    userAddress: account
                };

                const signature = await signer._signTypedData(domain, types, value);
                document.getElementById('signature').innerText = `Signature: ${signature}`;
                document.getElementById('status').innerText = 'Status: Message signed! Copy the signature above and paste it in Telegram.';
            } catch (error) {
                console.error("Error signing message:", error);
                document.getElementById('status').innerText = `Status: Error - ${error.message}`;
            }
        }
    </script>
</body>
</html>